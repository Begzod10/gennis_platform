name: Production Deploy

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |

            DEPLOY_TIME=$(date "+%Y-%m-%d %H:%M:%S")
            CONTRIBUTOR="${{ github.actor }}"

            cd /home/turon/

            source venv/bin/activate

            GIT_OUTPUT=$(git pull origin master 2>&1)

            sudo systemctl restart turon_platform 2>&1
            sudo systemctl restart celery 2>&1

            PLATFORM_STATUS=$(systemctl is-active turon_platform 2>&1)
            CELERY_STATUS=$(systemctl is-active celery 2>&1)

            MAKEMIGRATIONS_OUTPUT=$(python manage.py makemigrations 2>&1)
            MIGRATE_OUTPUT=$(python manage.py migrate 2>&1)

            API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://school.gennis.uz/api/Branch/branch_list/)

            if [ "$API_STATUS" = "200" ]; then
              API_MESSAGE="‚úÖ API OK"
            else
              API_MESSAGE="‚ùå API ERROR ($API_STATUS)"
            fi

            # HTML safe qilish
            SAFE_MAKEMIGRATIONS=$(echo "$MAKEMIGRATIONS_OUTPUT" | sed 's/&/&amp;/g; s/</&lt;/g; s/>/&gt;/g')
            SAFE_MIGRATE=$(echo "$MIGRATE_OUTPUT" | sed 's/&/&amp;/g; s/</&lt;/g; s/>/&gt;/g')

            cat <<EOF > /tmp/deploy_message.txt
<b>üöÄ Production Deploy</b>

üïí <b>Time:</b> $DEPLOY_TIME
üë§ <b>Contributor:</b> $CONTRIBUTOR

<b>Platform:</b> $PLATFORM_STATUS
<b>Celery:</b> $CELERY_STATUS
<b>API:</b> $API_STATUS
$API_MESSAGE

<b>Makemigrations:</b>
<pre>$SAFE_MAKEMIGRATIONS</pre>

<b>Migrate:</b>
<pre>$SAFE_MIGRATE</pre>
EOF

            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
              -d parse_mode=HTML \
              --data-urlencode text@/tmp/deploy_message.txt

            rm -f /tmp/deploy_message.txt
