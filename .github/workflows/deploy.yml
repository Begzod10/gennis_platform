name: Production Deploy

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |

            echo "ğŸš€ DEPLOY STARTED"
            DEPLOY_TIME=$(date "+%Y-%m-%d %H:%M:%S")
            CONTRIBUTOR="${{ github.actor }}"

            cd /home/turon/
            source venv/bin/activate


            echo "ğŸ“¥ Pulling latest code..."
            GIT_OUTPUT=$(git pull origin master 2>&1)

            echo "ğŸ”„ Restarting services..."
            sudo systemctl restart turon_platform
            sudo systemctl restart celery

            PLATFORM_STATUS=$(systemctl is-active turon_platform)
            CELERY_STATUS=$(systemctl is-active celery)

            echo "ğŸ Activating venv..."

            echo "ğŸ“¦ Running makemigrations..."
            MAKEMIGRATIONS_OUTPUT=$(python manage.py makemigrations 2>&1)

            echo "ğŸ“¦ Running migrate..."
            MIGRATE_OUTPUT=$(python manage.py migrate 2>&1)

            echo "ğŸŒ Checking API..."
            API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://school.gennis.uz/api/Branch/branch_list/)

            MESSAGE="ğŸ•’ Deploy time: $DEPLOY_TIME
ğŸ‘¤ Contributor: $CONTRIBUTOR

ğŸ“¥ Git Pull:
  $GIT_OUTPUT

ğŸ”§ Platform: $PLATFORM_STATUS
ğŸ”§ Celery: $CELERY_STATUS

ğŸ“¦ Makemigrations:
  $MAKEMIGRATIONS_OUTPUT

ğŸ“¦ Migrate:
  $MIGRATE_OUTPUT

ğŸŒ API Status: $API_STATUS"
  
  if [ "$API_STATUS" = "200" ]; then
  MESSAGE="$MESSAGE
  âœ… API OK"
  else
  MESSAGE="$MESSAGE
  âŒ API ERROR ($API_STATUS)"
  fi
  
  echo "ğŸ“¨ Sending Telegram message..."
  
  curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
  -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
  -d text="$MESSAGE"
