name: Production Deploy
on:
  push:
    branches:
      - master
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            DEPLOY_TIME=$(date "+%Y-%m-%d %H:%M:%S")
            CONTRIBUTOR="${{ github.actor }}"
            COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
            COMMIT_SHA="${{ github.sha }}"
            COMMIT_SHORT_SHA=$(echo "$COMMIT_SHA" | cut -c1-7)
            
            cd /home/turon/
            source venv/bin/activate
            cd backend
            
            if [ -f requirements.txt ]; then
              cp requirements.txt /tmp/old_requirements.txt
            else
              touch /tmp/old_requirements.txt
            fi
            
            echo "üì• Pulling latest code..."
            GIT_OUTPUT=$(git pull origin master 2>&1) || {
              echo "‚ùå Git pull failed!"
              exit 1
            }
            
            if [ -f requirements.txt ]; then
              NEW_PACKAGES=$(comm -13 <(sort /tmp/old_requirements.txt) <(sort requirements.txt) 2>/dev/null)
              REMOVED_PACKAGES=$(comm -23 <(sort /tmp/old_requirements.txt) <(sort requirements.txt) 2>/dev/null)
              
              if [ -n "$NEW_PACKAGES" ] || [ -n "$REMOVED_PACKAGES" ]; then
                echo "üì¶ Requirements changed, installing..."
                
                if [ -n "$NEW_PACKAGES" ]; then
                  echo "Installing new/updated packages:"
                  echo "$NEW_PACKAGES" | while read package; do
                    if [ -n "$package" ]; then
                      pip install "$package" --upgrade 2>&1
                    fi
                  done
                fi
                
                REQUIREMENTS_OUTPUT="New/Updated:$NEW_PACKAGES  Removed: $REMOVED_PACKAGES"
                REQUIREMENTS_INSTALLED="‚úÖ Dependencies updated"
              else
                echo "‚è≠Ô∏è  Requirements unchanged, skipping..."
                REQUIREMENTS_OUTPUT="No changes detected"
                REQUIREMENTS_INSTALLED="‚è≠Ô∏è  Skipped (no changes)"
              fi
            else
              REQUIREMENTS_OUTPUT="No requirements.txt found"
              REQUIREMENTS_INSTALLED="‚ö†Ô∏è  No requirements file"
            fi
            
            # Cleanup temp file
            rm -f /tmp/old_requirements.txt
            
            echo "üîÑ Running migrations..."
            MAKEMIGRATIONS_OUTPUT=$(python manage.py makemigrations 2>&1)
            MIGRATE_OUTPUT=$(python manage.py migrate 2>&1)
            
            echo "üîÑ Restarting services..."
            sudo systemctl restart turon_platform
            sudo systemctl restart celery
            
            sleep 5
            
            PLATFORM_STATUS=$(systemctl is-active turon_platform 2>&1)
            CELERY_STATUS=$(systemctl is-active celery 2>&1)
            
            API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://school.gennis.uz/api/Branch/branch_list/)
            if [ "$API_STATUS" = "200" ]; then
              API_MESSAGE="‚úÖ API OK"
            else
              API_MESSAGE="‚ùå API ERROR (HTTP $API_STATUS)"
            fi
            
            html_escape() {
              echo "$1" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g'
            }
            
            SAFE_COMMIT=$(html_escape "$COMMIT_MESSAGE")
            SAFE_GIT=$(html_escape "$GIT_OUTPUT")
            SAFE_REQUIREMENTS=$(html_escape "$REQUIREMENTS_OUTPUT")
            SAFE_MAKEMIGRATIONS=$(html_escape "$MAKEMIGRATIONS_OUTPUT")
            SAFE_MIGRATE=$(html_escape "$MIGRATE_OUTPUT")
            
            if [ "$PLATFORM_STATUS" = "active" ]; then
              PLATFORM_EMOJI="‚úÖ"
            else
              PLATFORM_EMOJI="‚ùå"
            fi
            
            if [ "$CELERY_STATUS" = "active" ]; then
              CELERY_EMOJI="‚úÖ"
            else
              CELERY_EMOJI="‚ùå"
            fi
            
            {
              echo "<b>üöÄ Production Deploy</b>"
              echo ""
              echo "üïí <b>Time:</b> $DEPLOY_TIME"
              echo "üë§ <b>Contributor:</b> $CONTRIBUTOR"
              echo "üìù <b>Commit:</b> <code>$COMMIT_SHORT_SHA</code>"
              echo "üí¨ <b>Message:</b> $SAFE_COMMIT"
              echo ""
              echo "<b>üìä Status:</b>"
              echo "$PLATFORM_EMOJI <b>Platform:</b> $PLATFORM_STATUS"
              echo "$CELERY_EMOJI <b>Celery:</b> $CELERY_STATUS"
              echo "$API_MESSAGE"
              echo ""
              echo "<b>üì• Git Pull:</b>"
              echo "<pre>$SAFE_GIT</pre>"
              echo ""
              echo "<b>üì¶ Requirements:</b> $REQUIREMENTS_INSTALLED"
              echo "<pre>$SAFE_REQUIREMENTS</pre>"
              echo ""
              echo "<b>üîÑ Makemigrations:</b>"
              echo "<pre>$SAFE_MAKEMIGRATIONS</pre>"
              echo ""
              echo "<b>üíæ Migrate:</b>"
              echo "<pre>$SAFE_MIGRATE</pre>"
            } > /tmp/deploy_message.txt
            
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
              -d parse_mode=HTML \
              --data-urlencode text@/tmp/deploy_message.txt
            
            rm -f /tmp/deploy_message.txt
            
            echo "‚úÖ Deployment completed successfully!"