name: Production Deploy
on:
  push:
    branches:
      - master
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            set -e  # Exit on error
            
            DEPLOY_TIME=$(date "+%Y-%m-%d %H:%M:%S")
            CONTRIBUTOR="${{ github.actor }}"
            
            # Navigate to project directory
            cd /home/turon/
            source venv/bin/activate
            
            # Save old requirements hash
            if [ -f requirements.txt ]; then
              OLD_REQ_HASH=$(md5sum requirements.txt | cut -d' ' -f1)
            else
              OLD_REQ_HASH=""
            fi
            
            # Pull latest code
            echo "üì• Pulling latest code..."
            GIT_OUTPUT=$(git pull origin master 2>&1)
            
            # Check if requirements changed
            if [ -f requirements.txt ]; then
              NEW_REQ_HASH=$(md5sum requirements.txt | cut -d' ' -f1)
            else
              NEW_REQ_HASH=""
            fi
            
            # Install dependencies only if changed
            if [ "$OLD_REQ_HASH" != "$NEW_REQ_HASH" ]; then
              echo "üì¶ Requirements changed, installing dependencies..."
              REQUIREMENTS_OUTPUT=$(pip install -r requirements.txt 2>&1)
              REQUIREMENTS_INSTALLED="‚úÖ Dependencies updated"
            else
              echo "‚è≠Ô∏è  Requirements unchanged, skipping..."
              REQUIREMENTS_OUTPUT="No changes detected"
              REQUIREMENTS_INSTALLED="‚è≠Ô∏è  Skipped (no changes)"
            fi
            
            # Run migrations
            echo "üîÑ Running migrations..."
            MAKEMIGRATIONS_OUTPUT=$(python manage.py makemigrations 2>&1)
            MIGRATE_OUTPUT=$(python manage.py migrate 2>&1)
            
            # Collect static files (if needed)
            # python manage.py collectstatic --noinput
            
            # Restart services
            echo "üîÑ Restarting services..."
            sudo systemctl restart turon_platform
            sudo systemctl restart celery
            
            # Wait for services to start
            sleep 5
            
            # Check service status
            PLATFORM_STATUS=$(systemctl is-active turon_platform 2>&1)
            CELERY_STATUS=$(systemctl is-active celery 2>&1)
            
            # Check API health
            API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://school.gennis.uz/api/Branch/branch_list/)
            if [ "$API_STATUS" = "200" ]; then
              API_MESSAGE="‚úÖ API OK"
            else
              API_MESSAGE="‚ùå API ERROR (HTTP $API_STATUS)"
            fi
            
            # HTML escape function
            html_escape() {
              echo "$1" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g'
            }
            
            SAFE_GIT=$(html_escape "$GIT_OUTPUT")
            SAFE_REQUIREMENTS=$(html_escape "$REQUIREMENTS_OUTPUT")
            SAFE_MAKEMIGRATIONS=$(html_escape "$MAKEMIGRATIONS_OUTPUT")
            SAFE_MIGRATE=$(html_escape "$MIGRATE_OUTPUT")
            
            # Platform status emoji
            if [ "$PLATFORM_STATUS" = "active" ]; then
              PLATFORM_EMOJI="‚úÖ"
            else
              PLATFORM_EMOJI="‚ùå"
            fi
            
            # Celery status emoji
            if [ "$CELERY_STATUS" = "active" ]; then
              CELERY_EMOJI="‚úÖ"
            else
              CELERY_EMOJI="‚ùå"
            fi
            
            # Create deployment message
            {
              echo "<b>üöÄ Production Deploy</b>"
              echo ""
              echo "üïí <b>Time:</b> $DEPLOY_TIME"
              echo "üë§ <b>Contributor:</b> $CONTRIBUTOR"
              echo ""
              echo "<b>üìä Status:</b>"
              echo "$PLATFORM_EMOJI <b>Platform:</b> $PLATFORM_STATUS"
              echo "$CELERY_EMOJI <b>Celery:</b> $CELERY_STATUS"
              echo "$API_MESSAGE"
              echo ""
              echo "<b>üì• Git Pull:</b>"
              echo "<pre>$SAFE_GIT</pre>"
              echo ""
              echo "<b>üì¶ Requirements:</b> $REQUIREMENTS_INSTALLED"
              echo "<pre>$SAFE_REQUIREMENTS</pre>"
              echo ""
              echo "<b>üîÑ Makemigrations:</b>"
              echo "<pre>$SAFE_MAKEMIGRATIONS</pre>"
              echo ""
              echo "<b>üíæ Migrate:</b>"
              echo "<pre>$SAFE_MIGRATE</pre>"
            } > /tmp/deploy_message.txt
            
            # Send to Telegram
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
              -d parse_mode=HTML \
              --data-urlencode text@/tmp/deploy_message.txt
            
            # Cleanup
            rm -f /tmp/deploy_message.txt
            
            echo "‚úÖ Deployment completed successfully!"